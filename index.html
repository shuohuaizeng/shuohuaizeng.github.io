<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>习惯打卡 - 养成良好习惯的助手</title>
    <!-- PWA相关元标签 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#34d399">
    <meta name="description" content="一个帮助您养成良好习惯的打卡应用">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="习惯打卡">
    <!-- iOS应用图标 -->
    <link rel="apple-touch-icon" href="/icons/icon-180x180.svg">
    <!-- 应用图标 -->
    <link rel="icon" type="image/svg+xml" href="/icons/icon-192x192.svg">
    <link rel="mask-icon" href="/icons/maskable-icon.svg" color="#34d399">
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#34d399',
                        secondary: '#6ee7b7',
                        accent: '#059669',
                        light: '#f0fdf4',
                        dark: '#065f46'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'checkmark': 'checkmark 0.5s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        checkmark: {
                            '0%': { strokeDashoffset: '100' },
                            '100%': { strokeDashoffset: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .btn-shadow {
                box-shadow: 0 4px 0 0 theme('colors.accent');
            }
            .btn-press {
                transform: translateY(4px);
                box-shadow: 0 0 0 0 theme('colors.accent');
            }
            .progress-ring-circle {
                transition: stroke-dashoffset 0.35s;
                transform: rotate(-90deg);
                transform-origin: 50% 50%;
            }
            .checkmark {
                stroke-dasharray: 100;
                stroke-dashoffset: 100;
                stroke-width: 2;
                stroke: white;
                fill: none;
                animation: checkmark 0.5s ease-out forwards;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
    <!-- 欢迎页面 -->
    <div id="welcome-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-cover bg-center" style="background-image: url('https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/b88410b3f59b438390f2bd6057a7b9cc~tplv-a9rns2rl98-image.image?rcl=20251129095316F9493681654D39663B45&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1766973250&amp;x-signature=BKTPKYDkYjWAE%2BaLkq%2Bd%2B16JHEs%3D');">
        <div class="text-center animate-fade-in">
            <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/58432c6c59ea423b82a1d52f9d2a202a~tplv-a9rns2rl98-image.image?rcl=20251129095316F9493681654D39663B45&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1766973228&amp;x-signature=toiKFFN%2FODh5RMYrvkDbweFAhKc%3D" alt="习惯打卡" class="w-32 h-32 mx-auto mb-6 animate-bounce-slow">
            <h1 class="text-4xl font-bold text-white mb-4 text-shadow">习惯打卡</h1>
            <p class="text-xl text-white mb-8 max-w-md mx-auto text-shadow">养成良好习惯，成就更好的自己</p>
            <button id="start-btn" class="bg-primary hover:bg-secondary text-white font-bold py-4 px-10 rounded-full text-lg transition-all duration-200 btn-shadow focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50">
                开始使用
            </button>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="app" class="hidden min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/58432c6c59ea423b82a1d52f9d2a202a~tplv-a9rns2rl98-image.image?rcl=20251129095316F9493681654D39663B45&amp;rk3s=8e244e95&amp;rrcfp=f06b921b&amp;x-expires=1766973228&amp;x-signature=toiKFFN%2FODh5RMYrvkDbweFAhKc%3D" alt="Logo" class="w-8 h-8 mr-2">
                    <h1 class="text-xl font-bold text-primary">习惯打卡</h1>
                </div>
                <div class="flex items-center">
                    <button id="notification-btn" class="p-2 rounded-full hover:bg-gray-100 relative">
                        <i class="fa fa-bell-o text-gray-600"></i>
                        <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    <button id="user-btn" class="ml-3 p-2 rounded-full hover:bg-gray-100">
                        <i class="fa fa-user-o text-gray-600"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- 页面内容将通过JavaScript动态加载 -->
            <div id="page-content"></div>
        </main>

        <!-- 底部导航栏 -->
        <nav class="bg-white shadow-[0_-1px_3px_rgba(0,0,0,0.1)] sticky bottom-0 z-10">
            <div class="container mx-auto px-4">
                <div class="flex justify-around py-3">
                    <button class="nav-btn flex flex-col items-center text-primary" data-page="dashboard">
                        <i class="fa fa-home text-xl"></i>
                        <span class="text-xs mt-1">首页</span>
                    </button>
                    <button class="nav-btn flex flex-col items-center text-gray-500" data-page="habits">
                        <i class="fa fa-list-alt text-xl"></i>
                        <span class="text-xs mt-1">习惯</span>
                    </button>
                    <button id="add-habit-btn" class="bg-primary hover:bg-secondary text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transform -translate-y-3 transition-all duration-200">
                        <i class="fa fa-plus text-xl"></i>
                    </button>
                    <button class="nav-btn flex flex-col items-center text-gray-500" data-page="stats">
                        <i class="fa fa-bar-chart text-xl"></i>
                        <span class="text-xs mt-1">统计</span>
                    </button>
                    <button class="nav-btn flex flex-col items-center text-gray-500" data-page="profile">
                        <i class="fa fa-user text-xl"></i>
                        <span class="text-xs mt-1">我的</span>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <!-- 添加习惯模态框 -->
    <div id="add-habit-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-md bg-white rounded-2xl p-6 shadow-xl animate-scale-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">添加新习惯</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <form id="add-habit-form">
                <div class="mb-4">
                    <label for="habit-name" class="block text-gray-700 text-sm font-medium mb-2">习惯名称</label>
                    <input type="text" id="habit-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="例如：晨跑、阅读、冥想..." required="">
                </div>
                <div class="mb-4">
                    <label for="habit-description" class="block text-gray-700 text-sm font-medium mb-2">习惯描述</label>
                    <textarea id="habit-description" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" rows="2" placeholder="简短描述这个习惯..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">习惯分类</label>
                    <div class="grid grid-cols-5 gap-2">
                        <label class="flex flex-col items-center cursor-pointer">
                            <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mb-1 border-2 border-transparent hover:border-primary">
                                <i class="fa fa-heartbeat text-primary text-xl"></i>
                            </div>
                            <input type="radio" name="habit-category" value="health" class="sr-only" required="">
                            <span class="text-xs text-gray-600">健康</span>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer">
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mb-1 border-2 border-transparent hover:border-primary">
                                <i class="fa fa-book text-primary text-xl"></i>
                            </div>
                            <input type="radio" name="habit-category" value="reading" class="sr-only">
                            <span class="text-xs text-gray-600">阅读</span>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer">
                            <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center mb-1 border-2 border-transparent hover:border-primary">
                                <i class="fa fa-briefcase text-primary text-xl"></i>
                            </div>
                            <input type="radio" name="habit-category" value="work" class="sr-only">
                            <span class="text-xs text-gray-600">工作</span>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer">
                            <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mb-1 border-2 border-transparent hover:border-primary">
                                <i class="fa fa-graduation-cap text-primary text-xl"></i>
                            </div>
                            <input type="radio" name="habit-category" value="study" class="sr-only">
                            <span class="text-xs text-gray-600">学习</span>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer">
                            <div class="w-12 h-12 rounded-full bg-pink-100 flex items-center justify-center mb-1 border-2 border-transparent hover:border-primary">
                                <i class="fa fa-coffee text-primary text-xl"></i>
                            </div>
                            <input type="radio" name="habit-category" value="other" class="sr-only">
                            <span class="text-xs text-gray-600">其他</span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="habit-frequency" class="block text-gray-700 text-sm font-medium mb-2">频率</label>
                    <select id="habit-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" required="">
                        <option value="daily">每天</option>
                        <option value="weekly">每周</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="habit-reminder" class="block text-gray-700 text-sm font-medium mb-2">提醒时间</label>
                    <input type="time" id="habit-reminder" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                    创建习惯
                </button>
            </form>
        </div>
    </div>

    <!-- 打卡成功提示 -->
    <div id="check-in-success" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl p-8 shadow-xl max-w-sm w-11/12 animate-scale-in text-center">
            <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                <svg width="40" height="40" viewBox="0 0 24 24">
                    <path class="checkmark" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">打卡成功！</h3>
            <p class="text-gray-600 mb-6">你真棒！继续保持这个好习惯</p>
            <button id="close-success-btn" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                继续加油
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 全局数据存储
        const appData = {
            habits: [],
            user: {
                name: "用户",
                streak: 0,
                achievements: []
            },
            currentPage: "dashboard"
        };

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化应用
            initApp();
            
            // 绑定事件监听器
            bindEventListeners();
        });

        // 初始化应用
        function initApp() {
            // 从本地存储加载数据
            loadData();
            
            // 如果没有习惯数据，添加一些示例数据
            if (appData.habits.length === 0) {
                addSampleHabits();
                saveData();
            }
            
            // 更新连续打卡天数
            updateStreak();
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 开始按钮点击事件
            document.getElementById('start-btn').addEventListener('click', function() {
                document.getElementById('welcome-screen').classList.add('animate-fade-out');
                setTimeout(() => {
                    document.getElementById('welcome-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('app').classList.add('animate-fade-in');
                    
                    // 加载默认页面（仪表盘）
                    loadPage('dashboard');
                }, 500);
            });
            
            // 底部导航按钮点击事件
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    loadPage(page);
                    
                    // 更新导航按钮样式
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('text-primary');
                        b.classList.add('text-gray-500');
                    });
                    this.classList.remove('text-gray-500');
                    this.classList.add('text-primary');
                });
            });
            
            // 添加习惯按钮点击事件
            document.getElementById('add-habit-btn').addEventListener('click', function() {
                document.getElementById('add-habit-modal').classList.remove('hidden');
            });
            
            // 关闭模态框按钮点击事件
            document.getElementById('close-modal-btn').addEventListener('click', function() {
                document.getElementById('add-habit-modal').classList.add('hidden');
            });
            
            // 添加习惯表单提交事件
            document.getElementById('add-habit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单数据
                const name = document.getElementById('habit-name').value;
                const description = document.getElementById('habit-description').value;
                const category = document.querySelector('input[name="habit-category"]:checked').value;
                const frequency = document.getElementById('habit-frequency').value;
                const reminder = document.getElementById('habit-reminder').value;
                
                // 创建新习惯
                const newHabit = {
                    id: generateId(),
                    name: name,
                    description: description,
                    category: category,
                    frequency: frequency,
                    reminder: reminder,
                    createdAt: new Date().toISOString(),
                    records: []
                };
                
                // 添加到习惯列表
                appData.habits.push(newHabit);
                
                // 保存数据
                saveData();
                
                // 关闭模态框
                document.getElementById('add-habit-modal').classList.add('hidden');
                
                // 重置表单
                this.reset();
                
                // 重新加载习惯页面
                if (appData.currentPage === 'habits' || appData.currentPage === 'dashboard') {
                    loadPage(appData.currentPage);
                }
                
                // 显示成功提示
                showToast('习惯创建成功！');
            });
            
            // 关闭打卡成功提示按钮点击事件
            document.getElementById('close-success-btn').addEventListener('click', function() {
                document.getElementById('check-in-success').classList.add('hidden');
                document.getElementById('check-in-success').classList.remove('flex');
            });
        }

        // 加载页面内容
        function loadPage(page) {
            appData.currentPage = page;
            const contentContainer = document.getElementById('page-content');
            
            switch(page) {
                case 'dashboard':
                    contentContainer.innerHTML = renderDashboard();
                    break;
                case 'habits':
                    contentContainer.innerHTML = renderHabits();
                    break;
                case 'stats':
                    contentContainer.innerHTML = renderStats();
                    break;
                case 'profile':
                    contentContainer.innerHTML = renderProfile();
                    break;
            }
            
            // 添加页面特定的事件监听器
            addPageEventListeners(page);
        }

        // 添加页面特定的事件监听器
        function addPageEventListeners(page) {
            switch(page) {
                case 'dashboard':
                    // 打卡按钮点击事件
                    document.querySelectorAll('.check-in-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const habitId = this.getAttribute('data-habit-id');
                            checkInHabit(habitId);
                        });
                    });
                    break;
                case 'habits':
                    // 打卡按钮点击事件
                    document.querySelectorAll('.habit-check-in-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const habitId = this.getAttribute('data-habit-id');
                            checkInHabit(habitId);
                        });
                    });
                    
                    // 编辑习惯按钮点击事件
                    document.querySelectorAll('.edit-habit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const habitId = this.getAttribute('data-habit-id');
                            editHabit(habitId);
                        });
                    });
                    
                    // 删除习惯按钮点击事件
                    document.querySelectorAll('.delete-habit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const habitId = this.getAttribute('data-habit-id');
                            deleteHabit(habitId);
                        });
                    });
                    break;
                case 'stats':
                    // 初始化图表
                    initCharts();
                    break;
            }
        }

        // 渲染仪表盘页面
        function renderDashboard() {
            // 获取今日日期
            const today = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = today.toLocaleDateString('zh-CN', dateOptions);
            
            // 获取今日待办习惯
            const todayHabits = getTodayHabits();
            
            // 获取已完成的习惯数量
            const completedCount = todayHabits.filter(habit => habit.completedToday).length;
            const totalCount = todayHabits.length;
            const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            
            // 渲染页面HTML
            return `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold">${dateString}</h2>
                            <p class="text-gray-600">连续打卡 <span class="font-bold text-primary">${appData.user.streak}</span> 天</p>
                        </div>
                        <div class="flex items-center">
                            <div class="w-16 h-16 rounded-full bg-primary bg-opacity-10 flex items-center justify-center mr-3">
                                <i class="fa fa-trophy text-primary text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">今日完成率</p>
                                <p class="text-xl font-bold text-primary">${completionRate}%</p>
                            </div>
                        </div>
                    </div>
                    
                    ${totalCount > 0 ? `
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">今日待办</h3>
                                <span class="text-sm text-gray-600">${completedCount}/${totalCount} 已完成</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${todayHabits.map(habit => `
                                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-center mb-3">
                                            <div class="flex items-center">
                                                <div class="w-10 h-10 rounded-full ${getCategoryColor(habit.category)} flex items-center justify-center mr-3">
                                                    <i class="fa ${getCategoryIcon(habit.category)} text-primary"></i>
                                                </div>
                                                <div>
                                                    <h4 class="font-bold">${habit.name}</h4>
                                                    <p class="text-xs text-gray-500">${habit.description || '无描述'}</p>
                                                </div>
                                            </div>
                                            <button class="check-in-btn ${habit.completedToday ? 'bg-green-100' : 'bg-primary hover:bg-secondary'} text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 focus:outline-none" data-habit-id="${habit.id}">
                                                ${habit.completedToday ? '<i class="fa fa-check"></i>' : '<i class="fa fa-plus"></i>'}
                                            </button>
                                        </div>
                                        ${habit.records.length > 0 ? `
                                            <div class="flex items-center text-xs text-gray-500">
                                                <i class="fa fa-calendar-check-o mr-1"></i>
                                                <span>已连续打卡 ${getStreakForHabit(habit)} 天</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="text-center py-10">
                            <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                <i class="fa fa-list-alt text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">还没有习惯</h3>
                            <p class="text-gray-500 mb-6">点击底部的 "+" 按钮添加你的第一个习惯吧！</p>
                            <button id="add-first-habit-btn" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 focus:outline-none">
                                添加习惯
                            </button>
                        </div>
                    `}
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4">习惯趋势</h3>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <canvas id="trends-chart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-4">AI 智能建议</h3>
                        <div class="bg-white rounded-xl p-6 shadow-sm border-l-4 border-primary">
                            <div class="flex items-start">
                                <div class="w-10 h-10 rounded-full bg-primary bg-opacity-10 flex items-center justify-center mr-3 flex-shrink-0">
                                    <i class="fa fa-lightbulb-o text-primary"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold mb-2">${getAIAdvice()}</h4>
                                    <p class="text-gray-600 text-sm">${getAIQuote()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 渲染习惯页面
        function renderHabits() {
            // 按类别分组习惯
            const habitsByCategory = {};
            appData.habits.forEach(habit => {
                if (!habitsByCategory[habit.category]) {
                    habitsByCategory[habit.category] = [];
                }
                habitsByCategory[habit.category].push(habit);
            });
            
            return `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">我的习惯</h2>
                        <span class="bg-primary bg-opacity-10 text-primary text-sm font-medium py-1 px-3 rounded-full">
                            ${appData.habits.length} 个习惯
                        </span>
                    </div>
                    
                    ${Object.keys(habitsByCategory).length > 0 ? `
                        ${Object.keys(habitsByCategory).map(category => `
                            <div class="mb-8">
                                <div class="flex items-center mb-4">
                                    <div class="w-8 h-8 rounded-full ${getCategoryColor(category)} flex items-center justify-center mr-2">
                                        <i class="fa ${getCategoryIcon(category)} text-primary text-sm"></i>
                                    </div>
                                    <h3 class="text-lg font-bold">${getCategoryName(category)}</h3>
                                </div>
                                <div class="space-y-3">
                                    ${habitsByCategory[category].map(habit => `
                                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div class="flex items-center mb-2">
                                                        <div class="w-8 h-8 rounded-full ${getCategoryColor(habit.category)} flex items-center justify-center mr-2">
                                                            <i class="fa ${getCategoryIcon(habit.category)} text-primary text-sm"></i>
                                                        </div>
                                                        <h4 class="font-bold">${habit.name}</h4>
                                                    </div>
                                                    <p class="text-sm text-gray-600 mb-3">${habit.description || '无描述'}</p>
                                                    <div class="flex items-center text-xs text-gray-500">
                                                        <div class="flex items-center mr-4">
                                                            <i class="fa fa-repeat mr-1"></i>
                                                            <span>${getFrequencyText(habit.frequency)}</span>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <i class="fa fa-calendar-check-o mr-1"></i>
                                                            <span>已连续打卡 ${getStreakForHabit(habit)} 天</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col items-end">
                                                    <button class="habit-check-in-btn ${habit.completedToday ? 'bg-green-100' : 'bg-primary hover:bg-secondary'} text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 focus:outline-none mb-2" data-habit-id="${habit.id}">
                                                        ${habit.completedToday ? '<i class="fa fa-check"></i>' : '<i class="fa fa-plus"></i>'}
                                                    </button>
                                                    <div class="flex space-x-1">
                                                        <button class="edit-habit-btn p-1 text-gray-500 hover:text-primary" data-habit-id="${habit.id}">
                                                            <i class="fa fa-pencil"></i>
                                                        </button>
                                                        <button class="delete-habit-btn p-1 text-gray-500 hover:text-red-500" data-habit-id="${habit.id}">
                                                            <i class="fa fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    ` : `
                        <div class="text-center py-10">
                            <div class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
                                <i class="fa fa-list-alt text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">还没有习惯</h3>
                            <p class="text-gray-500 mb-6">点击底部的 "+" 按钮添加你的第一个习惯吧！</p>
                            <button id="add-first-habit-btn" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition-all duration-200 focus:outline-none">
                                添加习惯
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        // 渲染统计页面
        function renderStats() {
            // 计算习惯完成率
            const completionData = calculateCompletionRate();
            
            // 获取习惯打卡趋势数据
            const trendData = getHabitTrends();
            
            // 获取成就数据
            const achievements = appData.user.achievements;
            
            return `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">数据统计</h2>
                        <div class="flex space-x-2">
                            <button class="stats-period-btn bg-primary text-white text-sm font-medium py-1 px-3 rounded-full" data-period="week">周</button>
                            <button class="stats-period-btn bg-gray-200 text-gray-700 text-sm font-medium py-1 px-3 rounded-full" data-period="month">月</button>
                            <button class="stats-period-btn bg-gray-200 text-gray-700 text-sm font-medium py-1 px-3 rounded-full" data-period="year">年</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-700">总体完成率</h3>
                                <span class="text-xl font-bold text-primary">${completionData.overallRate}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-primary h-2.5 rounded-full" style="width: ${completionData.overallRate}%"></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-gray-700">连续打卡天数</h3>
                                <span class="text-xl font-bold text-primary">${appData.user.streak}</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full bg-primary bg-opacity-10 flex items-center justify-center mr-3">
                                    <i class="fa fa-fire text-primary text-xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">当前连续打卡记录</p>
                                    <p class="text-xs text-gray-500">上次打卡: ${getLastCheckInDate()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4">习惯完成趋势</h3>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <canvas id="completion-chart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4">习惯完成情况</h3>
                        <div class="bg-white rounded-xl p-4 shadow-sm">
                            <canvas id="habits-chart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-4">我的成就</h3>
                        ${achievements.length > 0 ? `
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                ${achievements.map(achievement => `
                                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                                        <div class="w-16 h-16 rounded-full bg-primary bg-opacity-10 flex items-center justify-center mx-auto mb-3">
                                            <i class="fa ${achievement.icon} text-primary text-xl"></i>
                                        </div>
                                        <h4 class="font-bold text-sm mb-1">${achievement.name}</h4>
                                        <p class="text-xs text-gray-500">${achievement.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="bg-white rounded-xl p-4 shadow-sm text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3">
                                    <i class="fa fa-trophy text-gray-400 text-xl"></i>
                                </div>
                                <h4 class="font-bold mb-1">暂无成就</h4>
                                <p class="text-sm text-gray-500">继续坚持打卡，解锁更多成就！</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // 渲染个人页面
        function renderProfile() {
            return `
                <div class="animate-fade-in">
                    <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-24 h-24 rounded-full bg-primary bg-opacity-10 flex items-center justify-center mb-4">
                                <i class="fa fa-user text-primary text-4xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold mb-1">${appData.user.name}</h2>
                            <p class="text-gray-600 mb-4">坚持就是胜利</p>
                            <div class="flex space-x-4">
                                <div class="text-center">
                                    <p class="text-xl font-bold text-primary">${appData.habits.length}</p>
                                    <p class="text-xs text-gray-500">习惯数量</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xl font-bold text-primary">${getTotalCheckIns()}</p>
                                    <p class="text-xs text-gray-500">总打卡次数</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xl font-bold text-primary">${appData.user.streak}</p>
                                    <p class="text-xs text-gray-500">最长连续打卡</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-4">应用设置</h3>
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div class="flex justify-between items-center p-4 border-b border-gray-100">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-bell text-blue-500"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">通知提醒</h4>
                                        <p class="text-xs text-gray-500">接收习惯提醒通知</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            <div class="flex justify-between items-center p-4 border-b border-gray-100">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-moon-o text-purple-500"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">深色模式</h4>
                                        <p class="text-xs text-gray-500">切换应用主题</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                            <div class="flex justify-between items-center p-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                        <i class="fa fa-cloud-upload text-green-500"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">数据备份</h4>
                                        <p class="text-xs text-gray-500">备份你的打卡数据</p>
                                    </div>
                                </div>
                                <button id="backup-data-btn" class="bg-primary hover:bg-secondary text-white text-sm font-medium py-1 px-3 rounded-lg transition-all duration-200 focus:outline-none">
                                    备份
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-4">关于应用</h3>
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div class="p-4 border-b border-gray-100">
                                <h4 class="font-medium mb-1">习惯打卡 v1.0.0</h4>
                                <p class="text-xs text-gray-500">养成良好习惯的助手</p>
                            </div>
                            <div class="p-4 border-b border-gray-100">
                                <h4 class="font-medium mb-1">反馈与建议</h4>
                                <p class="text-xs text-gray-500">帮助我们改进应用</p>
                            </div>
                            <div class="p-4">
                                <h4 class="font-medium mb-1">隐私政策</h4>
                                <p class="text-xs text-gray-500">你的数据仅存储在本地</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 初始化图表
        function initCharts() {
            // 习惯趋势图表
            if (document.getElementById('trends-chart')) {
                const trendData = getHabitTrends();
                
                new Chart(document.getElementById('trends-chart'), {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: '打卡次数',
                            data: trendData.data,
                            borderColor: '#34d399',
                            backgroundColor: 'rgba(52, 211, 153, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
            
            // 习惯完成趋势图表
            if (document.getElementById('completion-chart')) {
                const completionData = calculateCompletionRateByDay();
                
                new Chart(document.getElementById('completion-chart'), {
                    type: 'bar',
                    data: {
                        labels: completionData.labels,
                        datasets: [{
                            label: '完成率',
                            data: completionData.data,
                            backgroundColor: '#34d399',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 习惯完成情况图表
            if (document.getElementById('habits-chart')) {
                const habitsData = getHabitsCompletionData();
                
                new Chart(document.getElementById('habits-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: habitsData.labels,
                        datasets: [{
                            data: habitsData.data,
                            backgroundColor: [
                                '#34d399',
                                '#6ee7b7',
                                '#a7f3d0',
                                '#d1fae5',
                                '#f0fdf4'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        cutout: '70%'
                    }
                });
            }
        }

        // 打卡习惯
        function checkInHabit(habitId) {
            const today = new Date().toISOString().split('T')[0];
            const habit = appData.habits.find(h => h.id === habitId);
            
            if (habit) {
                // 检查今天是否已经打卡
                const todayRecord = habit.records.find(r => r.date === today);
                
                if (todayRecord) {
                    // 已经打卡，取消打卡
                    habit.records = habit.records.filter(r => r.date !== today);
                    showToast('已取消今日打卡');
                } else {
                    // 未打卡，添加打卡记录
                    habit.records.push({
                        date: today,
                        completed: true,
                        notes: ''
                    });
                    
                    // 显示打卡成功提示
                    document.getElementById('check-in-success').classList.remove('hidden');
                    document.getElementById('check-in-success').classList.add('flex');
                    
                    // 检查是否解锁成就
                    checkAchievements();
                }
                
                // 更新连续打卡天数
                updateStreak();
                
                // 保存数据
                saveData();
                
                // 重新加载当前页面
                loadPage(appData.currentPage);
            }
        }

        // 编辑习惯
        function editHabit(habitId) {
            const habit = appData.habits.find(h => h.id === habitId);
            
            if (habit) {
                // 填充表单数据
                document.getElementById('habit-name').value = habit.name;
                document.getElementById('habit-description').value = habit.description || '';
                
                // 选中分类
                if (document.querySelector(`input[name="habit-category"][value="${habit.category}"]`)) {
                    document.querySelector(`input[name="habit-category"][value="${habit.category}"]`).checked = true;
                }
                
                document.getElementById('habit-frequency').value = habit.frequency;
                document.getElementById('habit-reminder').value = habit.reminder || '';
                
                // 显示模态框
                document.getElementById('add-habit-modal').classList.remove('hidden');
                
                // 修改表单提交事件处理
                const form = document.getElementById('add-habit-form');
                const originalSubmitHandler = form.onsubmit;
                
                form.onsubmit = function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const name = document.getElementById('habit-name').value;
                    const description = document.getElementById('habit-description').value;
                    const category = document.querySelector('input[name="habit-category"]:checked').value;
                    const frequency = document.getElementById('habit-frequency').value;
                    const reminder = document.getElementById('habit-reminder').value;
                    
                    // 更新习惯数据
                    habit.name = name;
                    habit.description = description;
                    habit.category = category;
                    habit.frequency = frequency;
                    habit.reminder = reminder;
                    
                    // 保存数据
                    saveData();
                    
                    // 关闭模态框
                    document.getElementById('add-habit-modal').classList.add('hidden');
                    
                    // 重置表单
                    form.reset();
                    
                    // 恢复原始提交处理
                    form.onsubmit = originalSubmitHandler;
                    
                    // 重新加载习惯页面
                    loadPage('habits');
                    
                    // 显示成功提示
                    showToast('习惯更新成功！');
                };
            }
        }

        // 删除习惯
        function deleteHabit(habitId) {
            if (confirm('确定要删除这个习惯吗？')) {
                appData.habits = appData.habits.filter(h => h.id !== habitId);
                
                // 保存数据
                saveData();
                
                // 重新加载习惯页面
                loadPage('habits');
                
                // 显示成功提示
                showToast('习惯已删除');
            }
        }

        // 检查成就解锁
        function checkAchievements() {
            const today = new Date().toISOString().split('T')[0];
            const totalCheckIns = getTotalCheckIns();
            const habitCount = appData.habits.length;
            const streak = appData.user.streak;
            
            // 成就列表
            const achievements = [
                {
                    id: 'first_checkin',
                    name: '第一步',
                    description: '完成第一次打卡',
                    icon: 'fa-star',
                    condition: totalCheckIns >= 1
                },
                {
                    id: 'three_days',
                    name: '坚持不懈',
                    description: '连续打卡3天',
                    icon: 'fa-calendar',
                    condition: streak >= 3
                },
                {
                    id: 'seven_days',
                    name: '一周达人',
                    description: '连续打卡7天',
                    icon: 'fa-trophy',
                    condition: streak >= 7
                },
                {
                    id: 'three_habits',
                    name: '习惯养成',
                    description: '创建3个习惯',
                    icon: 'fa-list-alt',
                    condition: habitCount >= 3
                },
                {
                    id: 'ten_checkins',
                    name: '打卡达人',
                    description: '累计打卡10次',
                    icon: 'fa-check-square-o',
                    condition: totalCheckIns >= 10
                }
            ];
            
            // 检查每个成就
            achievements.forEach(achievement => {
                // 如果条件满足且尚未解锁
                if (achievement.condition && !appData.user.achievements.some(a => a.id === achievement.id)) {
                    // 解锁成就
                    appData.user.achievements.push({
                        id: achievement.id,
                        name: achievement.name,
                        description: achievement.description,
                        icon: achievement.icon,
                        unlocked: true,
                        unlockedAt: today
                    });
                    
                    // 显示成就解锁提示
                    showToast(`解锁新成就：${achievement.name}！`);
                }
            });
            
            // 保存数据
            saveData();
        }

        // 更新连续打卡天数
        function updateStreak() {
            const today = new Date();
            let streak = 0;
            let currentDate = new Date(today);
            
            // 检查每一天是否有打卡记录
            while (true) {
                const dateString = currentDate.toISOString().split('T')[0];
                let hasCheckIn = false;
                
                // 检查是否有任何习惯在这一天打卡
                for (const habit of appData.habits) {
                    if (habit.records.some(record => record.date === dateString)) {
                        hasCheckIn = true;
                        break;
                    }
                }
                
                if (hasCheckIn) {
                    streak++;
                    // 继续检查前一天
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    // 如果今天没有打卡，不计算在内
                    if (currentDate.toDateString() === today.toDateString()) {
                        streak = 0;
                    }
                    break;
                }
            }
            
            // 更新连续打卡天数
            appData.user.streak = streak;
            
            // 保存数据
            saveData();
        }

        // 从本地存储加载数据
        function loadData() {
            const savedHabits = localStorage.getItem('habitTrackerHabits');
            const savedUser = localStorage.getItem('habitTrackerUser');
            
            if (savedHabits) {
                appData.habits = JSON.parse(savedHabits);
            }
            
            if (savedUser) {
                appData.user = JSON.parse(savedUser);
            }
        }

        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('habitTrackerHabits', JSON.stringify(appData.habits));
            localStorage.setItem('habitTrackerUser', JSON.stringify(appData.user));
        }

        // 添加示例习惯
        function addSampleHabits() {
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayString = yesterday.toISOString().split('T')[0];
            
            appData.habits = [
                {
                    id: '1',
                    name: '晨跑',
                    description: '每天早上跑步30分钟',
                    category: 'health',
                    frequency: 'daily',
                    reminder: '06:30',
                    createdAt: new Date().toISOString(),
                    records: [
                        { date: yesterdayString, completed: true, notes: '' },
                        { date: today, completed: false, notes: '' }
                    ]
                },
                {
                    id: '2',
                    name: '阅读',
                    description: '每天阅读30分钟',
                    category: 'reading',
                    frequency: 'daily',
                    reminder: '21:00',
                    createdAt: new Date().toISOString(),
                    records: [
                        { date: yesterdayString, completed: true, notes: '' },
                        { date: today, completed: false, notes: '' }
                    ]
                },
                {
                    id: '3',
                    name: '冥想',
                    description: '每天冥想15分钟',
                    category: 'health',
                    frequency: 'daily',
                    reminder: '07:00',
                    createdAt: new Date().toISOString(),
                    records: [
                        { date: today, completed: false, notes: '' }
                    ]
                }
            ];
            
            appData.user = {
                name: "用户",
                streak: 1,
                achievements: []
            };
        }

        // 获取今日待办习惯
        function getTodayHabits() {
            const today = new Date().toISOString().split('T')[0];
            
            return appData.habits.map(habit => {
                // 检查今天是否已经打卡
                const completedToday = habit.records.some(record => record.date === today);
                
                return {
                    ...habit,
                    completedToday
                };
            });
        }

        // 获取习惯的连续打卡天数
        function getStreakForHabit(habit) {
            if (!habit || habit.records.length === 0) {
                return 0;
            }
            
            // 按日期排序
            const sortedRecords = [...habit.records].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let streak = 0;
            let currentDate = new Date(sortedRecords[0].date);
            
            for (const record of sortedRecords) {
                const recordDate = new Date(record.date);
                
                // 检查日期是否连续
                if (recordDate.getTime() === currentDate.getTime()) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else if (recordDate.getTime() < currentDate.getTime()) {
                    // 如果日期不连续，停止计算
                    break;
                }
            }
            
            return streak;
        }

        // 获取习惯趋势数据
        function getHabitTrends(days = 7) {
            const labels = [];
            const data = [];
            
            const today = new Date();
            
            // 生成过去7天的数据
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const dateString = date.toISOString().split('T')[0];
                const dayLabel = date.getMonth() + 1 + '/' + date.getDate();
                
                labels.push(dayLabel);
                
                // 计算当天的打卡次数
                let checkIns = 0;
                for (const habit of appData.habits) {
                    if (habit.records.some(record => record.date === dateString)) {
                        checkIns++;
                    }
                }
                
                data.push(checkIns);
            }
            
            return { labels, data };
        }

        // 计算习惯完成率
        function calculateCompletionRate() {
            if (appData.habits.length === 0) {
                return { overallRate: 0, completed: 0, total: 0 };
            }
            
            const today = new Date().toISOString().split('T')[0];
            let completed = 0;
            let total = 0;
            
            for (const habit of appData.habits) {
                total++;
                
                // 检查今天是否已经打卡
                if (habit.records.some(record => record.date === today)) {
                    completed++;
                }
            }
            
            const overallRate = Math.round((completed / total) * 100);
            
            return { overallRate, completed, total };
        }

        // 按天计算习惯完成率
        function calculateCompletionRateByDay(days = 7) {
            const labels = [];
            const data = [];
            
            const today = new Date();
            
            // 生成过去7天的数据
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const dateString = date.toISOString().split('T')[0];
                const dayLabel = date.getMonth() + 1 + '/' + date.getDate();
                
                labels.push(dayLabel);
                
                // 计算当天的完成率
                let completed = 0;
                let total = appData.habits.length;
                
                for (const habit of appData.habits) {
                    if (habit.records.some(record => record.date === dateString)) {
                        completed++;
                    }
                }
                
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
                data.push(rate);
            }
            
            return { labels, data };
        }

        // 获取习惯完成情况数据
        function getHabitsCompletionData() {
            const labels = [];
            const data = [];
            
            // 只显示前5个习惯
            const habitsToShow = appData.habits.slice(0, 5);
            
            for (const habit of habitsToShow) {
                labels.push(habit.name);
                
                // 计算完成率
                const totalDays = habit.records.length;
                const completedDays = habit.records.filter(record => record.completed).length;
                
                const completionRate = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;
                data.push(completionRate);
            }
            
            return { labels, data };
        }

        // 获取总打卡次数
        function getTotalCheckIns() {
            let total = 0;
            
            for (const habit of appData.habits) {
                total += habit.records.length;
            }
            
            return total;
        }

        // 获取上次打卡日期
        function getLastCheckInDate() {
            let lastDate = null;
            
            for (const habit of appData.habits) {
                for (const record of habit.records) {
                    const recordDate = new Date(record.date);
                    
                    if (!lastDate || recordDate > lastDate) {
                        lastDate = recordDate;
                    }
                }
            }
            
            if (!lastDate) {
                return '从未打卡';
            }
            
            return lastDate.toLocaleDateString('zh-CN');
        }

        // 获取AI建议
        function getAIAdvice() {
            const advices = [
                "坚持是成功的关键",
                "每天进步一点点",
                "习惯养成需要时间和耐心",
                "专注于过程，而非结果",
                "庆祝每一个小成就",
                "不要害怕偶尔的失败",
                "找到适合自己的节奏",
                "让习惯成为生活的一部分"
            ];
            
            return advices[Math.floor(Math.random() * advices.length)];
        }

        // 获取AI名言
        function getAIQuote() {
            const quotes = [
                "成功不是偶然，而是习惯的必然结果。",
                "优秀不是一种行为，而是一种习惯。- 亚里士多德",
                "我们今天的选择决定了我们明天的习惯。",
                "习惯是第二天性。",
                "播下一个行动，收获一种习惯；播下一种习惯，收获一种性格；播下一种性格，收获一种命运。",
                "好习惯让人立于不败之地，坏习惯则让人从成功的宝座上跌下来。",
                "成功的秘诀在于养成迅速行动的习惯。"
            ];
            
            return quotes[Math.floor(Math.random() * quotes.length)];
        }

        // 获取类别名称
        function getCategoryName(category) {
            const categories = {
                'health': '健康',
                'reading': '阅读',
                'work': '工作',
                'study': '学习',
                'other': '其他'
            };
            
            return categories[category] || '其他';
        }

        // 获取类别图标
        function getCategoryIcon(category) {
            const icons = {
                'health': 'fa-heartbeat',
                'reading': 'fa-book',
                'work': 'fa-briefcase',
                'study': 'fa-graduation-cap',
                'other': 'fa-coffee'
            };
            
            return icons[category] || 'fa-coffee';
        }

        // 获取类别颜色
        function getCategoryColor(category) {
            const colors = {
                'health': 'bg-green-100',
                'reading': 'bg-blue-100',
                'work': 'bg-purple-100',
                'study': 'bg-yellow-100',
                'other': 'bg-pink-100'
            };
            
            return colors[category] || 'bg-gray-100';
        }

        // 获取频率文本
        function getFrequencyText(frequency) {
            const frequencies = {
                'daily': '每天',
                'weekly': '每周',
                'custom': '自定义'
            };
            
            return frequencies[frequency] || '每天';
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 显示提示消息
        function showToast(message) {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in';
            toast.textContent = message;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 3秒后移除
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 3000);
        }
    </script>
    
    <!-- PWA安装提示按钮 -->
    <div id="install-prompt" class="fixed bottom-4 right-4 bg-primary text-white p-4 rounded-lg shadow-lg z-50 hidden">
      <div class="flex items-center justify-between">
        <div class="mr-4">
          <h3 class="font-bold">添加到主屏幕</h3>
          <p class="text-sm opacity-90">将习惯打卡应用安装到您的设备</p>
        </div>
        <div class="flex gap-2">
          <button id="install-button" class="bg-white text-primary px-4 py-2 rounded-md font-medium hover:bg-opacity-90 transition-colors">
            安装
          </button>
          <button id="dismiss-install" class="bg-transparent text-white px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-10 transition-colors">
            稍后
          </button>
        </div>
      </div>
    </div>

    <!-- PWA Service Worker注册 -->
    <script>
      // 存储安装提示事件
      let deferredPrompt;
      const installPromptElement = document.getElementById('install-prompt');
      const installButton = document.getElementById('install-button');
      const dismissInstallButton = document.getElementById('dismiss-install');

      // 监听beforeinstallprompt事件
      window.addEventListener('beforeinstallprompt', (e) => {
        // 阻止Chrome 67及更早版本自动显示安装提示
        e.preventDefault();
        // 存储事件以便稍后触发
        deferredPrompt = e;
        // 显示自定义安装按钮
        installPromptElement.classList.remove('hidden');
        console.log('可以安装PWA了');
      });

      // 安装按钮点击事件
      installButton.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        // 显示安装提示
        deferredPrompt.prompt();
        
        // 等待用户响应
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`用户选择: ${outcome}`);
        
        // 无论结果如何，重置延迟提示变量
        deferredPrompt = null;
        // 隐藏安装提示
        installPromptElement.classList.add('hidden');
      });

      // 关闭安装提示
      dismissInstallButton.addEventListener('click', () => {
        installPromptElement.classList.add('hidden');
        // 可以存储用户的拒绝，一段时间内不再显示
        localStorage.setItem('installPromptDismissed', Date.now());
      });

      // 监听已安装事件
      window.addEventListener('appinstalled', (evt) => {
        console.log('应用已安装');
        installPromptElement.classList.add('hidden');
        // 可以显示安装成功的通知
      });

      // 注册Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('Service Worker 注册成功，作用域:', registration.scope);
              
              // 检查更新
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // 有新版本可用，提示用户刷新
                    if (confirm('发现新版本，是否更新？')) {
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch(error => {
              console.error('Service Worker 注册失败:', error);
            });
        });
        
        // 监听控制器变化，处理更新
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          refreshing = true;
          window.location.reload();
        });
        
        // 后台同步功能
        if ('sync' in window.registration) {
          // 监听消息
          navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'SYNC_DATA') {
              // 执行数据同步
              syncDataWithServer();
            }
          });
        }
        
        // 请求通知权限
        if ('Notification' in window) {
          Notification.requestPermission().then(permission => {
            console.log('通知权限状态:', permission);
          });
        }
      }
      
      // 数据同步函数
      function syncDataWithServer() {
        // 这里实现与服务器同步数据的逻辑
        console.log('执行数据同步...');
        // 可以从localStorage获取未同步的数据并发送到服务器
        const unsyncedData = localStorage.getItem('unsynced_data');
        if (unsyncedData) {
          console.log('发现未同步数据，准备发送');
          // 实际项目中这里应该有发送数据到服务器的代码
          // 发送成功后清除未同步标记
        }
      }
    </script>

</body></html>